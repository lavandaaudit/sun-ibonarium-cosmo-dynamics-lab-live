<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8">
<title>Живе Сонце • Helioviewer API V2</title>
<style>
    body { background: black; color: white; font-family: "Segoe UI", sans-serif; margin: 0; }
    canvas { display: block; margin: auto; background: #000; }
    .controls { text-align: center; margin-top: 10px; }
    button { margin: 5px; padding: 10px 20px; font-size: 16px; cursor: pointer; }
</style>
</head>
<body>
<canvas id="sunCanvas" width="900" height="1000"></canvas>

<div class="controls">
    <button id="minusBtn">–</button>
    <button id="plusBtn">+</button>
    <button id="saveBtn">ЗБЕРЕГТИ (JPEG)</button>
    <br>
    <button class="channelBtn" data-id="10">171</button>
    <button class="channelBtn" data-id="13">304</button>
    <button class="channelBtn" data-id="11">193</button>
    <button class="channelBtn" data-id="12">211</button>
    <div id="photoTime" style="margin-top: 10px; color: #9999ff;"></div>
</div>

<script>
const canvas = document.getElementById('sunCanvas');
const ctx = canvas.getContext('2d');

let scale = 1.0;
let sourceId = 10; // 171 Å
let img = new Image();
let photoTime = "завантаження...";

async function loadSun(id = 10) {
    const now = new Date().toISOString();
    const url = `https://api.helioviewer.org/v2/takeScreenshot/?date=${encodeURIComponent(now)}&imageScale=2.42&layers=[${id}]&x0=0&y0=0&width=1024&height=1024&display=true&watermark=true`;

    try {
        const resp = await fetch(url);
        const blob = await resp.blob();

        photoTime = now.replace("T", " ").split(".")[0] + " UTC";

        return new Promise(resolve => {
            img.onload = () => resolve(img);
            img.src = URL.createObjectURL(blob);
        });
    } catch (e) {
        console.error("Помилка завантаження:", e);
        photoTime = "немає зв'язку";
    }
}

function draw() {
    ctx.fillStyle = "black";
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    if (img.complete) {
        const w = img.width * scale;
        const h = img.height * scale;
        ctx.drawImage(img, (canvas.width - w) / 2, (canvas.height - h) / 2, w, h);
    }

    ctx.fillStyle = "#9999ff";
    ctx.font = "22px Segoe UI";
    ctx.fillText(photoTime, 20, canvas.height - 260);
}

document.getElementById("minusBtn").addEventListener("click", () => { scale = Math.max(0.4, scale - 0.15); draw(); });
document.getElementById("plusBtn").addEventListener("click", () => { scale = Math.min(2.5, scale + 0.15); draw(); });
document.getElementById("saveBtn").addEventListener("click", () => {
    const link = document.createElement('a');
    link.download = `Сонце_${sourceId}_${new Date().toISOString().replace(/[:.]/g, "-")}.jpg`;
    link.href = canvas.toDataURL("image/jpeg");
    link.click();
});

document.querySelectorAll(".channelBtn").forEach(btn => {
    btn.addEventListener("click", async () => {
        sourceId = btn.dataset.id;
        await loadSun(sourceId);
        draw();
    });
});

canvas.addEventListener("wheel", e => {
    if (e.deltaY < 0) scale = Math.min(2.5, scale + 0.15);
    if (e.deltaY > 0) scale = Math.max(0.4, scale - 0.15);
    draw();
    e.preventDefault();
});

setInterval(async () => { await loadSun(sourceId); draw(); }, 60000);

loadSun(sourceId).then(draw);
</script>
</body>
</html>
